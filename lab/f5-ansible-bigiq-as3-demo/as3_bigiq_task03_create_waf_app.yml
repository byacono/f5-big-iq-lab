---
- name: BIG-IQ and AS3 Lab - Task 3a - HTTPS Application with Web Application Firewall
  hosts: udf-bigiq-cm-01
  vars_files:
    - inventory/group_vars/udf-bigiq-cm-01.yml

  tasks: 
    - name: Get BIG-IQ Token POST /mgmt/shared/authn/login (auth_bigiq.json or auth_bigiq_radius.json)
      uri:
        url: https://{{ bigiq_cm_server }}/mgmt/shared/authn/login
        method: POST
        headers:
          Content-Type: application/json
        body: "{{ lookup('file','auth_bigiq_radius_paul.json') }}"
        body_format: json
        timeout: 60
        status_code: 200, 202
        validate_certs: false
      register: auth

    - name: Task 3a - HTTPS Application with Web Application Firewall - POST /mgmt/shared/appsvcs/declare?async=true
      uri:
        url: https://{{ bigiq_cm_server }}/mgmt/shared/appsvcs/declare?async=true
        method: POST
        headers:
          Content-Type: application/json
          X-F5-Auth-Token: "{{auth.json.token.token}}"
        body:
          # used https://www.json2yaml.com/ to convert JSON declaration to YAML
          class: AS3
          action: deploy
          persist: true
          declaration:
            class: ADC
            schemaVersion: "{{ as3_schemaVersion }}"
            id: isc-lab
            label: Task3a
            remark: Task 3a - HTTPS Application with WAF
            target:
              hostname: "{{ bigip_target }}"
            Task3:
              class: Tenant
              MyWebApp3waf:
                class: Application
                template: https
                statsProfile:
                  class: Analytics_Profile
                  collectedStatsInternalLogging: true
                  collectedStatsExternalLogging: false
                  capturedTrafficInternalLogging: false
                  capturedTrafficExternalLogging: true
                  collectPageLoadTime: true
                  collectClientSideStatistics: true
                  collectResponseCode: true
                  sessionCookieSecurity: ssl-only
                serviceMain:
                  class: Service_HTTPS
                  virtualAddresses:
                  - "{{ task3a_vs }}"
                  pool: web_pool
                  profileAnalytics:
                    use: statsProfile
                  serverTLS: webtls
                  policyWAF:
                    bigip: "{{ task3_policyWAF }}"
                web_pool:
                  class: Pool
                  monitors:
                  - http
                  members:
                  - servicePort: 80
                    serverAddresses:
                    - "{{ task3a_node1 }}"
                    - "{{ task3a_node2 }}"
                    shareNodes: true
                webtls:
                  class: TLS_Server
                  certificates:
                  - certificate: webcert
                webcert:
                  class: Certificate
                  certificate:
                    bigip: "/Common/default.crt"
                  privateKey:
                    bigip: "/Common/default.key"
        body_format: json
        timeout: 60
        status_code: 200, 202
        validate_certs: false
      register: json_response

    - debug:
        var: json_response.json

### LOOP TO CHECK THE TASK - DO NOT MODIFY BELOW

    - name: Check AS3 Deployment Task - GET /mgmt/shared/appsvcs/task/<task_id>
      uri:
        url: https://{{ bigiq_cm_server }}/mgmt/shared/appsvcs/task/{{json_response.json.id}}
        method: GET
        headers:
          Content-Type: application/json
          X-F5-Auth-Token: "{{auth.json.token.token}}"
        timeout: 60
        status_code: 200, 202
        validate_certs: false
      register: json_response_task

    - debug:
        var: json_response_task.json

    - name: LOOP Check AS3 Deployment Task - GET /mgmt/shared/appsvcs/task/<task_id>
      uri:
        url: https://{{ bigiq_cm_server }}/mgmt/shared/appsvcs/task/{{json_response.json.id}}
        method: GET
        headers:
          Content-Type: application/json
          X-F5-Auth-Token: "{{auth.json.token.token}}"
        status_code: 200, 202
        validate_certs: false
      register: json_response_task
      until: "json_response_task.json[0].results != 'pending'"
      retries: 20
      delay: 30

    - debug:
        var: json_response_task.json